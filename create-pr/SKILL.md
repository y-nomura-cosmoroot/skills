---
name: create-pr
description: ブランチ名とコミット内容からタイトル・説明を自動生成してGitHub PRを作成する
user-invocable: true
---

# PR作成ワークフロー

ブランチ名・コミット履歴・差分を分析し、PRのタイトルと説明文を自動生成する。
ユーザーの承認を得てからPRを作成する。

**起動時に表示:** 「PRの作成を開始します。ブランチの情報を分析しています...」

## ステップ1: ブランチ情報の収集

**重要**: GitHubのPR比較は `origin/main` と `origin/<ブランチ>` の間で行われる。正確な差分を得るために:
1. `git fetch` でリモート追跡ブランチを最新化すること
2. 比較対象はローカル `HEAD` ではなく `origin/<ブランチ>`（リモートブランチ）を使うこと（未プッシュのコミットはPRに含まれないため）

まず最初にリモート情報を更新し、ブランチ名を取得する:

```bash
# リモート追跡ブランチを最新化（必須・最初に実行）
git fetch origin

# 現在のブランチ名
git branch --show-current
```

次にリモートブランチの存在を確認し、比較対象を決定する:

```bash
# リモートにブランチが存在するか確認
git ls-remote --heads origin $(git branch --show-current)
```

**比較対象の決定ルール:**
- リモートにブランチが存在する場合 → `origin/<ブランチ>` を比較対象とする（GitHubのPR表示と一致）
- リモートにブランチが存在しない場合 → `HEAD` を比較対象とする（まだプッシュされていないため）

以下、比較対象を `<COMPARE_REF>` として記載する（`origin/<ブランチ>` または `HEAD`）:

```bash
# ベースブランチとの分岐点を特定（リモートのmainまたはmaster）
git merge-base <COMPARE_REF> origin/main 2>/dev/null || git merge-base <COMPARE_REF> origin/master 2>/dev/null

# ベースブランチからのコミット一覧
git log origin/main..<COMPARE_REF> --oneline --no-merges 2>/dev/null || git log origin/master..<COMPARE_REF> --oneline --no-merges 2>/dev/null

# ベースブランチからの差分（ファイル単位のサマリ）
git diff origin/main..<COMPARE_REF> --stat 2>/dev/null || git diff origin/master..<COMPARE_REF> --stat 2>/dev/null

# ベースブランチからの差分（内容）
git diff origin/main..<COMPARE_REF> 2>/dev/null || git diff origin/master..<COMPARE_REF> 2>/dev/null

# 未コミットの変更があるか確認
git status --short
```

### 未プッシュのコミットがある場合

リモートブランチが存在し、ローカルがリモートより先行している場合は警告を表示する:

```bash
# ローカルとリモートの差分を確認
git rev-list origin/<ブランチ>..HEAD --count
```

未プッシュのコミットがある場合:
```
⚠️ 未プッシュのコミットが <N> 件あります:
<コミット一覧>

これらはPRに含まれません。先にプッシュしますか？
```

AskUserQuestionで確認:
- 「プッシュしてから続ける」→ プッシュ後に `origin/<ブランチ>` で再比較
- 「このまま続ける」→ プッシュ済みの内容のみでPR作成を続行

### 未コミットの変更がある場合

警告を表示する:
```
⚠️ 未コミットの変更があります:
<変更ファイル一覧>

これらはPRに含まれません。先にコミットしますか？
```

AskUserQuestionで確認:
- 「コミットしてから続ける」→ `/commit-changes` スキルの手順に従いコミットメッセージを生成・提示（実際のcommitはユーザーが行う。ユーザーがcommitしたら続行。コミット後は未プッシュ警告のフローに進む）
- 「このまま続ける」→ 未コミット分を除いてPR作成を続行

## ステップ2: タイトルの自動生成

以下の優先順で情報を組み合わせてタイトルを生成する:

### 2-1. ブランチ名の解析

ブランチ名からキーワードを抽出する:
- `feature/xxx` `add_xxx` → 「xxxの追加」
- `fix/xxx` `bugfix/xxx` → 「xxxの修正」
- `improve/xxx` `enhance/xxx` → 「xxxの改善」
- `refactor/xxx` → 「xxxのリファクタリング」
- その他 → ブランチ名をそのままヒントとして使用

### 2-2. コミット履歴の分析

コミットメッセージ群から主要な変更テーマを特定する:
- 最も頻出するキーワード・トピック
- コミットメッセージの1行目の共通パターン

### 2-3. 差分の分析

変更されたファイル・コードの内容から:
- どの機能領域に変更が集中しているか
- 新規追加 vs 既存変更の比率

### 2-4. タイトル生成ルール

- 日本語で記述
- 50文字以内
- 「何を」「どうした」が分かる簡潔な表現
- 例: 「行動別ドーナツチャートと円グラフの追加」

## ステップ3: 説明文の自動生成

以下の構造で説明文を生成する:

```markdown
## 目的
<なぜこのPRが必要なのか、どのような課題・要望に対応するのかを1〜3文で>

## 概要
<このPRで実現することの全体像を簡潔に。レビュアーが「何をしたPRか」を一目で把握できるように>

## 変更内容
- <変更カテゴリ1>
  - <具体的な変更点>
  - <具体的な変更点>
- <変更カテゴリ2>
  - <具体的な変更点>

## 設計・実装方針
<どのような作りになっているかをレビュアー向けに説明する>

- **アーキテクチャ**: <新規クラス/モジュールの構成、既存コードとの関係>
- **データフロー**: <データがどう流れるか、主要な処理の流れ>
- **主要な設計判断**: <なぜこの実装方針を選んだか、トレードオフがあれば記載>

## 影響範囲
- **機能への影響**: <既存機能への影響。影響なしの場合も明記>
- **UI/表示への影響**: <画面表示の変更点。該当しない場合は省略>
- **パフォーマンスへの影響**: <処理速度やリソース使用量への影響。該当しない場合は省略>

## 確認方法
<レビュアーがこのPRを確認する際の手順>

1. <確認手順1: 具体的な操作や実行コマンド>
2. <確認手順2: 期待される結果>
3. <確認手順3: エッジケースや注意点>

### 確認観点
- [ ] <チェック項目1>
- [ ] <チェック項目2>
- [ ] <チェック項目3>

## 変更ファイル
| ファイル | 変更種別 | 概要 |
|---------|---------|------|
| `path/to/file1.py` | 新規 / 変更 / 削除 | <変更概要> |
| `path/to/file2.py` | 新規 / 変更 / 削除 | <変更概要> |
```

### 説明文の生成ルール

- 日本語で記述
- レビュアーがコードを読む前にPRの全体像を理解できることを最優先にする
- 実装視点で具体的に記述（「〜を追加」「〜を変更」）
- コミットメッセージの内容を整理・統合して記載する
- **目的**: ブランチ名・コミット履歴から「なぜ」を推測して記述する
- **設計・実装方針**: diffを分析し、クラス構成・継承関係・モジュール間の依存を読み取って記述する
- **影響範囲**: 変更が他の機能に波及するかをdiffから判断する。影響がない場合も「既存機能への影響なし」と明記する
- **確認方法**: 変更内容に応じた具体的な操作手順を記載する（コマンド実行、画面操作など）。チェックリストはレビュアーが1つずつ確認できる粒度にする
- 変更ファイルはテーブル形式で、変更種別（新規/変更/削除）を明示する

## ステップ4: ユーザーへの確認

以下の形式で生成結果を表示する:

```
## PR作成プレビュー

**マージ方向:** `<現在のブランチ>` → `<ベースブランチ>`
**コミット数:** <N>件

### タイトル
<生成したタイトル>

### 説明文
<生成した説明文>
```

表示後、AskUserQuestionで確認する:

| 選択肢 | 動作 |
|--------|------|
| このまま作成する | ステップ5に進む |
| タイトルを修正 | ユーザーが入力した新しいタイトルで差し替えてステップ5に進む |
| 説明文を修正 | ユーザーが入力した修正内容を反映してステップ5に進む |
| キャンセル | PR作成を中止する |

## ステップ5: リモートブランチの確認とPR作成

### 5-1. リモートブランチの確認

ステップ1で確認したリモートブランチの存在状況に応じて分岐する:

**リモートにブランチが存在しない場合:**

```
リモートにブランチがまだプッシュされていません。
PRを作成するには先にプッシュが必要です。
```

AskUserQuestionで確認:
- 「プッシュしてPRを作成」→ `git push -u origin <ブランチ名>` を実行し、続けてPRを作成
- 「自分でプッシュする」→ プッシュコマンドを表示して終了。ユーザーがプッシュ後に再度スキルを実行

**リモートにブランチが存在する場合:**

ローカルとリモートの差分を確認:
```bash
git status -sb
```

ローカルがリモートより先行している場合は同様にプッシュの確認を行う。

### 5-2. PR作成

```bash
gh pr create --base <ベースブランチ> --head <現在のブランチ> --title "<タイトル>" --body "$(cat <<'EOF'
<説明文>
EOF
)"
```

### 5-3. 結果の表示

作成成功時:
```
✅ PRを作成しました！
<PRのURL>
```

作成失敗時:
```
❌ PR作成に失敗しました:
<エラーメッセージ>
```

## 注意事項

- CLAUDE.mdのgit操作禁止ルールについて: このスキルでは `git push` と `gh pr create` を使用するが、PR作成というユーザーの明示的な意図に基づく操作であるため、ユーザー承認を得た上で実行する
- ベースブランチはデフォルトで `origin/main` を使用する。`origin/main` が存在しない場合は `origin/master` を試行する。ローカルの `main` ブランチは古い可能性があるため、必ず `origin/` プレフィックス付きのリモート追跡ブランチを使用すること
- PRのタイトル・説明文はすべて日本語で生成する
