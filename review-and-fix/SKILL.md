---
name: review-and-fix
description: PRをレビューし、指摘を重要度順に1件ずつ確認・修正するワークフロー
argument-hint: "<PR番号>"
user-invocable: true
---

# PRレビュー & 修正ワークフロー

指定されたPRのdiffをレビューし、指摘事項を重要度順に1件ずつユーザーに提示する。
修正 or スキップを選択し、全件対応後にサマリーを出力する。

## ステップ1: PR番号の確定

### PR番号が指定されている場合（$ARGUMENTS が空でない）

そのまま次のステップに進む。

### PR番号が指定されていない場合（$ARGUMENTS が空）

1. 以下のコマンドでオープン中のPR一覧を取得する:

```bash
gh pr list --json number,title,headRefName,author --limit 20
```

2. 取得結果に応じて分岐する:

| PR数 | 動作 |
|------|------|
| 0件 | 「オープン中のPRがありません」と表示して終了 |
| 1件 | そのPRを自動選択し、次のステップに進む |
| 2件以上 | AskUserQuestionでユーザーにどのPRをレビューするか選択させる |

3. 2件以上の場合、AskUserQuestionの選択肢は各PRの `#<番号> <タイトル> (<ブランチ名>)` とする（最大4件まで表示、5件以上は「その他（PR番号を入力）」で対応）

選択されたPR番号を以降の `$ARGUMENTS` として使用する。

## ステップ2: PR情報の取得

以下のコマンドでPRの情報とdiffを取得する。

```bash
gh pr view $ARGUMENTS --json number,title,body,baseRefName,headRefName
gh pr diff $ARGUMENTS
```

取得に失敗した場合はエラーメッセージを表示して終了する。

## ステップ3: コードレビューの実施

取得したdiffを **全ファイル・全行** 精査し、以下の観点でレビューする。

### レビュー観点（重要度順）

| 重要度 | ラベル | 対象 |
|--------|--------|------|
| 🔴 | Critical | セキュリティ脆弱性、データ損失リスク、クラッシュ原因 |
| 🟠 | High | バグ、ロジックエラー、エッジケース未対応 |
| 🟡 | Medium | パフォーマンス問題、可読性低下、DRY原則違反、設計上の懸念 |
| 🔵 | Low | コードスタイル、命名規則、コメント不足 |
| ⚪ | Info | 提案・改善案（対応必須ではない） |

### 各指摘に含める情報

- **重要度**（Critical / High / Medium / Low / Info）
- **ファイルパスと行番号**
- **指摘内容**（何が問題か、なぜ問題か）
- **修正案**（具体的なコード変更提案）

### レビュー時の注意

- CLAUDE.mdの指針（DRY原則等）に基づいてレビューする
- プロジェクト全体の文脈を理解した上で指摘する（必要に応じて関連ファイルを読む）
- 単なるスタイル指摘よりも、実質的なバグやリスクを優先する
- 指摘がゼロの場合は「問題なし」と報告して終了する

## ステップ4: レビュー結果の保存

レビュー結果を `.claude/reviews/pr-$ARGUMENTS.md` に保存する。
ディレクトリが存在しない場合は作成する。

### 保存フォーマット

```markdown
# PR #<番号> レビュー結果

## PR情報
- タイトル: <タイトル>
- ブランチ: <head> → <base>
- レビュー日時: <YYYY-MM-DD HH:MM>

## 指摘一覧

### [1] 🔴 Critical: <指摘タイトル>
- **ファイル**: <ファイルパス>:<行番号>
- **指摘**: <内容>
- **修正案**: <具体的な修正コード>
- **ステータス**: 未対応

### [2] 🟠 High: <指摘タイトル>
...
```

保存後、ユーザーに指摘の一覧（番号・重要度・タイトルのみ）を表示する。

## ステップ5: 指摘の順次確認・修正

レビュー結果を **重要度の高い順** に1件ずつユーザーに提示する。

### 各指摘の処理フロー

1. 指摘内容と修正案を画面に表示する
2. AskUserQuestionでユーザーに確認する:

| 選択肢 | 動作 |
|--------|------|
| 修正する | 修正案に沿ってコードを修正する |
| 方針を変えて修正 | ユーザーが入力した方針で修正する |
| スキップ | この指摘は対応しない |

3. 対応結果をレビューファイルに記録する:
   - 修正した場合 → ステータスを `✅ 修正済み` に更新
   - スキップした場合 → ステータスを `⏭️ スキップ` に更新

4. 次の指摘へ進む

**全件の確認が完了するまでこのループを繰り返す。**

## ステップ6: 最終サマリー

全指摘の対応が完了したら:

1. レビューファイルの末尾にサマリーを追記する

```markdown
## 対応サマリー
- ✅ 修正済み: X件
- ⏭️ スキップ: X件
- 合計: X件
```

2. 画面にもサマリーを表示する

## ステップ7: READMEの更新

修正が1件以上ある場合、コードの変更によりREADMEの記載内容が実装と乖離している可能性がある。
`/update-readme` スキルを実行してREADMEを最新の実装に合わせて更新する。

## ステップ8: コミットメッセージの作成

修正が1件以上ある場合、コミットメッセージを生成してユーザーに提示する。

### 生成ルール

1. `git diff` で変更内容を確認する
2. 以下のフォーマットでコミットメッセージを作成する:

```
<変更の要約（1行、日本語）>

<変更の詳細（箇条書き、日本語）>
```

3. コミットメッセージをコードブロックで画面に表示する

### 注意

- **実際のgit commitは実行しない**（CLAUDE.mdのgit操作禁止ルールに準拠）
- メッセージの提示のみ行い、コミットはユーザーが手動で行う

## 注意事項

- CLAUDE.mdの指針に準拠すること（DRY原則、git操作禁止等）
- 修正前に必ず対象ファイルをReadで読み込むこと
- 除外ファイル（CLAUDE.mdで指定）はレビュー対象外とすること
- AskUserQuestionの選択肢は必ず上記3つ（修正する / 方針を変えて修正 / スキップ）とすること
