---
name: review-and-fix
description: PRをレビューし、指摘を重要度順に1件ずつ確認・修正するワークフロー
argument-hint: "<PR番号>"
user-invocable: true
---

# PRレビュー & 修正ワークフロー

指定されたPRのdiffをレビューし、指摘事項を重要度順に1件ずつユーザーに提示する。
修正 or スキップを選択し、全件対応後にサマリーを出力する。

## ステップ1: PR番号の確定

### PR番号が指定されている場合（$ARGUMENTS が空でない）

そのまま次のステップに進む。

### PR番号が指定されていない場合（$ARGUMENTS が空）

1. 以下のコマンドでオープン中のPR一覧を取得する:

```bash
gh pr list --json number,title,headRefName,author --limit 20
```

2. 取得結果に応じて分岐する:

| PR数 | 動作 |
|------|------|
| 0件 | 「オープン中のPRがありません」と表示して終了 |
| 1件 | そのPRを自動選択し、次のステップに進む |
| 2件以上 | AskUserQuestionでユーザーにどのPRをレビューするか選択させる |

3. 2件以上の場合、AskUserQuestionの選択肢は各PRの `#<番号> <タイトル> (<ブランチ名>)` とする（最大4件まで表示、5件以上は「その他（PR番号を入力）」で対応）

選択されたPR番号を以降の `$ARGUMENTS` として使用する。

## ステップ2: PR情報の取得

以下のコマンドでPRの情報とdiffを取得する。

```bash
gh pr view $ARGUMENTS --json number,title,body,baseRefName,headRefName
gh pr diff $ARGUMENTS
```

取得に失敗した場合はエラーメッセージを表示して終了する。

## ステップ3: コードレビューの実施

### 3-1: code-reviewerエージェントによるレビュー

まず、Taskツールで `code-reviewer` エージェントを起動し、専門的なレビューを実施する。

```
Taskツール呼び出し:
  subagent_type: code-reviewer
  prompt: |
    PR #<番号> のコードレビューを実施してください。
    対象ブランチ: <head> → <base>

    以下のdiffを全ファイル・全行精査し、指摘事項を重要度順にリストアップしてください。
    各指摘には「重要度（Critical/High/Medium/Low/Info）」「ファイルパスと行番号」
    「問題の説明」「修正案」を含めてください。

    <ここにgh pr diffの出力を渡す>
```

### 3-2: 追加観点でのレビュー

code-reviewerの結果を受け取った後、以下の **5つの重点観点** で漏れがないか追加レビューする。
code-reviewerが既に指摘済みの項目は重複させない。

#### ① セキュリティ

- SQLインジェクション、コマンドインジェクション、XSSの可能性
- 認証・認可チェックの漏れ（エンドポイント追加時に認証ミドルウェアを通しているか）
- ユーザー入力のバリデーション・サニタイズ不足
- 機密情報（トークン、パスワード）のハードコードやログ出力

#### ② パフォーマンス

- N+1クエリ（ループ内でのDB/API呼び出し）
- 不要な再レンダリング（React: useCallback/useMemo の欠如、deps配列の誤り）
- 大量データの一括読み込み（ページネーション・遅延読み込みの未対応）
- 重い処理のメインスレッド実行

#### ③ 保守性（6ヶ月後の自分が読めるか）

- 意図が不明な変数名・関数名
- 1関数が複数の責務を持っている（単一責任原則違反）
- マジックナンバー・マジックストリングの直書き
- 複雑な条件分岐が説明なしに書かれている

#### ④ エッジケース

- null / undefined / None の未処理
- 空配列・空文字列の考慮漏れ
- 並行処理・競合状態（race condition）のリスク
- 境界値（0、負数、最大値）の未考慮

#### ⑤ 過剰設計（YAGNI違反）

- 現時点で使われていない抽象化レイヤー
- 呼び出し元が1箇所しかないのに汎用化されたインターフェース
- 将来の要件を先取りした不要な設定項目やフラグ
- 過度なデザインパターンの適用（シンプルな処理への Factory/Strategy 等）

### 3-3: 指摘の統合と重要度分類

code-reviewerの指摘と追加レビューの指摘を統合し、以下の重要度で分類する。

| 重要度 | ラベル | 対象 |
|--------|--------|------|
| 🔴 | Critical | セキュリティ脆弱性（①）、データ損失リスク、クラッシュ原因 |
| 🟠 | High | バグ、ロジックエラー、エッジケース未対応（④）、認証漏れ（①） |
| 🟡 | Medium | パフォーマンス問題（②）、保守性の低下（③）、DRY原則違反、過剰設計（⑤） |
| 🔵 | Low | コードスタイル、命名規則、コメント不足 |
| ⚪ | Info | 提案・改善案（対応必須ではない） |

### 各指摘に含める情報

- **重要度**（Critical / High / Medium / Low / Info）
- **観点**（①〜⑤ または一般）
- **ファイルパスと行番号**
- **指摘内容**（何が問題か、なぜ問題か）
- **修正案**（具体的なコード変更提案）

### レビュー時の注意

- CLAUDE.mdの指針（DRY原則等）に基づいてレビューする
- プロジェクト全体の文脈を理解した上で指摘する（必要に応じて関連ファイルを読む）
- 単なるスタイル指摘よりも、実質的なバグやリスクを優先する
- code-reviewerの指摘と追加レビューの指摘が重複する場合は1つにまとめる
- 指摘がゼロの場合は「問題なし」と報告して終了する
- `.claude/reviews/` へのレビュー結果ファイルの保存はこのスキルの意図的な動作であるため、指摘対象外とする

## ステップ4: レビュー結果の保存

レビュー結果を `.claude/reviews/pr-$ARGUMENTS.md` に保存する。
ディレクトリが存在しない場合は作成する。

### ファイルが既に存在する場合（2回目以降のレビュー）

`.claude/reviews/pr-$ARGUMENTS.md` が既に存在する場合、以前のレビュー結果を保持したまま末尾に追記する。
既存の内容は削除・上書きしない。

追記時は以下の区切りを挿入してから新しいレビュー結果を書く:

```markdown
---

# PR #<番号> レビュー結果（第N回）
```

「第N回」の番号は、ファイル内の既存レビュー回数 + 1 とする。

### 保存フォーマット

```markdown
# PR #<番号> レビュー結果

## PR情報
- タイトル: <タイトル>
- ブランチ: <head> → <base>
- レビュー日時: <YYYY-MM-DD HH:MM>

## 指摘一覧

### [1] 🔴 Critical: <指摘タイトル>
- **観点**: ①セキュリティ
- **ファイル**: <ファイルパス>:<行番号>
- **指摘**: <内容>
- **修正案**: <具体的な修正コード>
- **ステータス**: 未対応

### [2] 🟠 High: <指摘タイトル>
- **観点**: ④エッジケース
...
```

保存後、ユーザーに指摘の一覧（番号・重要度・タイトルのみ）を表示する。

## ステップ5: 指摘の順次確認・修正

レビュー結果を **重要度の高い順** に1件ずつユーザーに提示する。

### 各指摘の処理フロー

1. 指摘内容と修正案を画面に表示する
2. AskUserQuestionでユーザーに確認する:

| 選択肢 | 動作 |
|--------|------|
| 修正する | 修正案に沿ってコードを修正する |
| 方針を変えて修正 | ユーザーが入力した方針で修正する |
| スキップ | この指摘は対応しない |

3. 対応結果をレビューファイルに記録する:
   - 修正した場合 → ステータスを `✅ 修正済み` に更新
   - スキップした場合 → ステータスを `⏭️ スキップ` に更新

4. 次の指摘へ進む

**全件の確認が完了するまでこのループを繰り返す。**

## ステップ6: 最終サマリー

全指摘の対応が完了したら:

1. レビューファイルの末尾にサマリーを追記する

```markdown
## 対応サマリー
- ✅ 修正済み: X件
- ⏭️ スキップ: X件
- 合計: X件
```

2. 画面にもサマリーを表示する

## ステップ7: READMEの更新

修正が1件以上ある場合、コードの変更によりREADMEの記載内容が実装と乖離している可能性がある。
`/update-readme` スキルを実行してREADMEを最新の実装に合わせて更新する。

## ステップ8: コミットメッセージの作成

修正が1件以上ある場合、コミットメッセージを生成してユーザーに提示する。

### 生成ルール

1. `git diff` で変更内容を確認する
2. 以下のフォーマットでコミットメッセージを作成する:

```
<変更の要約（1行、日本語）>

<変更の詳細（箇条書き、日本語）>
```

3. コミットメッセージをコードブロックで画面に表示する

### 注意

- **実際のgit commitは実行しない**（CLAUDE.mdのgit操作禁止ルールに準拠）
- メッセージの提示のみ行い、コミットはユーザーが手動で行う

## 注意事項

- CLAUDE.mdの指針に準拠すること（DRY原則、git操作禁止等）
- 修正前に必ず対象ファイルをReadで読み込むこと
- 除外ファイル（CLAUDE.mdで指定）はレビュー対象外とすること
- AskUserQuestionの選択肢は必ず上記3つ（修正する / 方針を変えて修正 / スキップ）とすること
